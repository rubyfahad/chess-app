<script>
$(function() {
  $('.piece').draggable({
    snap: '.square',
    snapMode: 'outer',
    snapTolerance: 40,
    opacity: 0.75,
    cursor: 'crosshair',
    containment: 'table',
    revert: 'invalid'
  });

  $('.square').droppable({
    accept: '.piece',
    drop: function(event, ui) {
      var piece = ui.draggable
      var destination_square = $(this);
      var update_piece = {
        id: piece.data('piece-id'),
        x_position: destination_square.data('x-position'),
        y_position: destination_square.data('y-position')
      }

      $.ajax({
        type: 'PATCH',
        url: '/pieces/' + update_piece.id,
        beforeSend: $.rails.CSRFProtection,
        dataType: 'json',
        data: {
          piece: update_piece
        },
        success: function(data) {
          $(location).attr('href', data.update_url);
        }
      });
    }
  });
});

</script>

<div class="chessboard">
  <table>
    <% (0..7).each do |row| %>
      <tr class="row">
        <% (0..7).each do |column| %>
          <td class="square" x-position="<%=column%>" y-position="<%=row%>">
          <% piece = @game.piece_data[column][row]%>
          <% if piece.present? %>
            <div class="piece" piece-id="<%=piece.id%>">
              <%= piece.unicode_symbol.html_safe%>
            </div>
          </td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </table>
</div>
